<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Multiplayer Car Race</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif }
canvas { background:#2b2b2b; display:block; margin:auto; }
button {
  padding:12px 18px;
  font-size:16px;
  margin:6px;
}
#status { margin:8px; }
</style>
</head>

<body>

<h2>üèÅ Multiplayer Car Race</h2>
<div id="status">Waiting for players‚Ä¶</div>
<button id="readyBtn">READY</button>
<canvas id="game" width="360" height="640"></canvas>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<script>
// üî¥ PASTE YOUR OWN API KEY BELOW (Reminder: quotes ke andar)
const ably = new Ably.Realtime("KFH2jQ.KSseqA:9U2adiC7ZnNFJ3udjlabtaVDzPEqnRHbKoG7zElCdC8");
const channel = ably.channels.get("race-room-1");

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const readyBtn = document.getElementById("readyBtn");
const statusText = document.getElementById("status");

let myId = Math.random().toString(36).slice(2,7);
let gameStarted = false;
let readyPlayers = {};
let players = {};
let startTime = null;
const finishY = 40;

// player create
players[myId] = {
  x: 80 + Math.random()*180,
  y: 560,
  targetY: 560,
  color: "#" + Math.floor(Math.random()*16777215).toString(16),
  finished: false
};

// READY button
readyBtn.onclick = () => {
  readyBtn.disabled = true;
  channel.publish("ready", { id: myId });
};

// receive messages
channel.subscribe(msg => {
  if(msg.name === "ready"){
    readyPlayers[msg.data.id] = true;
    checkStart();
  }

  if(msg.name === "start"){
    gameStarted = true;
    startTime = Date.now();
    statusText.innerText = "RACE STARTED!";
    readyBtn.style.display = "none";
  }

  if(msg.name === "move" && msg.data.id !== myId){
    if(!players[msg.data.id]) players[msg.data.id] = msg.data;
    players[msg.data.id].targetY = msg.data.y;
  }

  if(msg.name === "finish"){
    statusText.innerText = `üèÜ WINNER: ${msg.data.id}`;
    gameStarted = false;
  }
});

// check if all players ready
function checkStart(){
  const count = Object.keys(readyPlayers).length;
  statusText.innerText = `${count} player(s) READY`;
  if(count >= 2){ // minimum 2 players
    channel.publish("start", {});
  }
}

// touch control (only own car)
canvas.addEventListener("touchstart", () => {
  if(!gameStarted) return;
  players[myId].targetY -= 35;
});

// update positions smoothly
function update(){
  for(let id in players){
    let p = players[id];
    if(p.y > p.targetY) p.y -= 4;

    if(gameStarted && !p.finished && p.y <= finishY){
      p.finished = true;
      channel.publish("finish", { id });
    }
  }
}

// draw car (better texture)
function drawCar(p){
  // body
  ctx.fillStyle = p.color;
  ctx.fillRect(p.x, p.y, 26, 36);

  // windows
  ctx.fillStyle = "#ddd";
  ctx.fillRect(p.x+6, p.y+6, 14, 10);

  // wheels
  ctx.fillStyle = "black";
  ctx.fillRect(p.x-3, p.y+6, 3, 8);
  ctx.fillRect(p.x+26, p.y+6, 3, 8);
  ctx.fillRect(p.x-3, p.y+22, 3, 8);
  ctx.fillRect(p.x+26, p.y+22, 3, 8);
}

// draw everything
function draw(){
  ctx.clearRect(0,0,360,640);

  // finish line
  ctx.fillStyle = "white";
  ctx.fillRect(0, finishY, 360, 5);

  for(let id in players){
    drawCar(players[id]);
  }

  // timer
  if(gameStarted && startTime){
    let t = ((Date.now()-startTime)/1000).toFixed(1);
    statusText.innerText = `‚è± ${t}s`;
  }
}

// sync + loop
setInterval(()=>{
  if(gameStarted){
    channel.publish("move", {
      id: myId,
      x: players[myId].x,
      y: players[myId].targetY,
      color: players[myId].color
    });
  }
  update();
  draw();
},50);
</script>

</body>
</html>
